<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị - Chill</title> 
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <!-- 3. KẾT NỐI VỚI FILE KEY.JS -->
    <script src="key.js"></script>

    <!-- 4. QUILL.JS (RICH TEXT EDITOR) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- 5. FEATHER ICONS -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* (CSS chung, font chữ) */
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .loader { border-top-color: #0d9488; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* CSS cho Tab Admin */
        .tab-button.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #0d9488;
        }
        /* Tùy chỉnh Quill Editor */
        #quill-editor-container .ql-toolbar {
            border-top-left-radius: 0.375rem; /* rounded-md */
            border-top-right-radius: 0.375rem;
            border-color: #D1D5DB; /* border-gray-300 */
        }
        #quill-editor-container .ql-container {
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            border-color: #D1D5DB;
            min-height: 250px;
        }
    </style>
</head>

<body class="bg-gradient-to-b from-white via-gray-50 to-white text-slate-700">

    <!-- (Navbar giữ nguyên) -->
    <header class="bg-white/95 backdrop-blur-sm shadow-sm sticky top-0 z-50">
        <nav class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <a href="index.html" class="text-3xl font-extrabold text-teal-600 transition-transform duration-300 hover:scale-105">
                Chill
            </a>
        </nav>
    </header>

    <!-- ========= MAIN CONTENT (NỘI DUNG CHÍNH) ========= -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

        <!-- (Các phần loader, denied giữ nguyên) -->
        <div id="admin-loader" class="text-center text-slate-500 py-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div>
            <p>Đang kiểm tra quyền truy cập...</p>
        </div>
        <div id="admin-denied" class="hidden text-center text-red-600 py-20">
             <h2 class="text-2xl font-bold">Truy cập bị từ chối</h2>
             <p class="mt-2">Bạn không có quyền admin để xem trang này.</p>
             <a href="index.html" class="inline-block mt-4 px-4 py-2 text-white bg-teal-600 rounded-lg">Quay về Trang chủ</a>
        </div>

        <!-- (NỘI DUNG ADMIN) -->
        <div id="admin-dashboard" class="hidden">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight mb-8">
                Trang Quản Trị (Admin)
            </h1>
            
            <!-- (CẬP NHẬT) Thanh Tabs (còn 5 tabs) -->
            <div class="border-b border-gray-200 mb-8">
                <nav class="flex flex-wrap space-x-6 -mb-px">
                    <button id="tab-posts" data-panel="posts-panel" class="tab-button active text-lg font-semibold py-4 px-1 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                        Quản lý Bài viết
                    </button>
                    <button id="tab-quizzes" data-panel="quizzes-panel" class="tab-button text-lg font-semibold py-4 px-1 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                        Quản lý Câu đố
                    </button>
                    <button id="tab-topics" data-panel="topics-panel" class="tab-button text-lg font-semibold py-4 px-1 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                        Quản lý Chủ đề
                    </button>
                    <button id="tab-users" data-panel="users-panel" class="tab-button text-lg font-semibold py-4 px-1 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                        Quản lý Người dùng
                    </button>
                    <button id="tab-utils" data-panel="utils-panel" class="tab-button text-lg font-semibold py-4 px-1 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                        Công cụ (Dev)
                    </button>
                </nav>
            </div>

            <!-- Panel 1: Quản lý Bài viết -->
            <div id="posts-panel" class="tab-panel">
                <button id="toggle-post-form" class="mb-6 px-5 py-2 font-semibold text-white bg-gradient-to-r from-teal-500 to-cyan-600 rounded-lg hover:from-teal-600 hover:to-cyan-700 transition-all">
                    + Tạo bài viết mới
                </button>
                
                <form id="create-post-form" class="hidden bg-white p-6 rounded-lg shadow-md mb-8 space-y-4">
                    <h3 class="text-xl font-bold">Form tạo bài viết</h3>
                    <div>
                        <label for="post-title" class="block font-medium">Tiêu đề</label>
                        <input type="text" id="post-title" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="post-cover-image" class="block font-medium">Ảnh bìa (Cover Image)</label>
                        <input type="file" id="post-cover-image" accept="image/*" class="mt-1 w-full p-2 border border-gray-300 rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                    </div>
                    <div>
                        <label for="post-category" class="block font-medium">Danh mục (Category)</label>
                        <input type="text" id="post-category" placeholder="Ví dụ: KỸ NĂNG" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="post-description" class="block font-medium">Mô tả ngắn</label>
                        <textarea id="post-description" rows="3" required class="mt-1 w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label class="block font-medium">Nội dung (Chấp nhận định dạng)</label>
                        <div id="quill-editor-container" class="mt-1">
                            <div id="quill-editor">
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="px-5 py-2 font-semibold text-white bg-teal-600 rounded-lg hover:bg-teal-700">Lưu bài viết</button>
                        <span id="upload-status" class="text-blue-600 ml-4"></span>
                        <span id="post-form-message" class="text-green-600 ml-4"></span>
                    </div>
                </form>

                <!-- Bảng danh sách bài viết -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left font-semibold">Tiêu đề</th>
                                <th class="p-4 text-left font-semibold">Danh mục</th>
                                <th class="p-4 text-left font-semibold">Ngày tạo</th>
                                <th class="p-4 text-left font-semibold">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="posts-table-body">
                            <!-- JS sẽ chèn <tr> vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- (ĐÃ XÓA) Panel 2: Quản lý Minigame -->
            
            <!-- Panel 3: Quản lý Câu đố -->
            <div id="quizzes-panel" class="tab-panel hidden">
                <button id="toggle-quiz-form" class="mb-6 px-5 py-2 font-semibold text-white bg-gradient-to-r from-teal-500 to-cyan-600 rounded-lg hover:from-teal-600 hover:to-cyan-700 transition-all">
                    + Tạo câu đố mới
                </button>
                
                <!-- Form tạo câu đố -->
                <form id="create-quiz-form" class="hidden bg-white p-6 rounded-lg shadow-md mb-8 space-y-4">
                    <h3 class="text-xl font-bold">Form tạo câu đố</h3>
                    <div>
                        <label for="quiz-question" class="block font-medium">Câu hỏi</label>
                        <textarea id="quiz-question" rows="3" required class="mt-1 w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    
                    <!-- Các phương án -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="quiz-option-1" class="block font-medium">Phương án 1 (A)</label>
                            <input type="text" id="quiz-option-1" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="quiz-option-2" class="block font-medium">Phương án 2 (B)</label>
                            <input type="text" id="quiz-option-2" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="quiz-option-3" class="block font-medium">Phương án 3 (C)</label>
                            <input type="text" id="quiz-option-3" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="quiz-option-4" class="block font-medium">Phương án 4 (D)</label>
                            <input type="text" id="quiz-option-4" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div>
                        <label for="quiz-correct-answer" class="block font-medium">Đáp án đúng</label>
                        <select id="quiz-correct-answer" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            <option value="1">Phương án 1 (A)</option>
                            <option value="2">Phương án 2 (B)</option>
                            <option value="3">Phương án 3 (C)</option>
                            <option value="4">Phương án 4 (D)</option>
                        </select>
                    </div>
                    
                    <div>
                        <button type="submit" class="px-5 py-2 font-semibold text-white bg-teal-600 rounded-lg hover:bg-teal-700">Lưu Câu đố</button>
                        <span id="quiz-form-message" class="text-green-600 ml-4"></span>
                    </div>
                </form>

                <!-- Bảng danh sách câu đố -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left font-semibold">Câu hỏi</th>
                                <th class="p-4 text-left font-semibold">Đáp án đúng</th>
                                <th class="p-4 text-left font-semibold">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="quizzes-table-body">
                            <!-- JS sẽ chèn <tr> vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Panel 4: Quản lý Chủ đề -->
            <div id="topics-panel" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4">Danh sách Chủ đề Diễn đàn</h2>
                <!-- Bảng danh sách chủ đề -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left font-semibold">Tiêu đề</th>
                                <th class="p-4 text-left font-semibold">Tác giả</th>
                                <th class="p-4 text-left font-semibold">Ngày tạo</th>
                                <th class="p-4 text-left font-semibold">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="topics-table-body">
                            <!-- JS (đã có) sẽ chèn <tr> vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Panel 5: Quản lý Người dùng -->
            <div id="users-panel" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4">Danh sách Người dùng</h2>
                <!-- Bảng danh sách người dùng -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left font-semibold">Tên hiển thị</th>
                                <th class="p-4 text-left font-semibold">Email</th>
                                <th class="p-4 text-left font-semibold">Vai trò</th>
                                <th class="p-4 text-left font-semibold">Ngày tạo</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- JS (đã có) sẽ chèn <tr> vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Panel 6: Công cụ (Dev) -->
            <div id="utils-panel" class="tab-panel hidden space-y-8">
                
                <!-- Công cụ 1: Đăng Trả lời Hàng loạt (Nâng cao) -->
                <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <h3 class="text-lg font-semibold">Công cụ 1: Đăng Trả lời Hàng loạt (Seeding)</h3>
                    <p class="text-sm text-gray-500 mb-3">Đăng hàng loạt trả lời (với tên ảo) vào một chủ đề có sẵn, mô phỏng thời gian đăng.</p>
                    
                    <form id="seed-advanced-replies-form" class="space-y-4">
                        <div>
                            <label for="seed-replies-topic-select" class="block font-medium">1. Chọn Chủ đề có sẵn</label>
                            <select id="seed-replies-topic-select" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <!-- JS sẽ tải các chủ đề vào đây -->
                            </select>
                        </div>
                        
                        <!-- Ô chọn ngày -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="seed-replies-start-date" class="block font-medium text-sm">Đăng từ ngày (Tùy chọn)</label>
                                <input type="date" id="seed-replies-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="seed-replies-end-date" class="block font-medium text-sm">Đăng đến ngày (Tùy chọn)</label>
                                <input type="date" id="seed-replies-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>

                        <div>
                            <label for="seed-replies-textarea" class="block font-medium">2. Dán danh sách trả lời (mỗi câu 1 dòng)</label>
                            <input type="text" readonly value="Quy ước: [QUOTE]Nội dung trích dẫn[/QUOTE] Nội dung trả lời." class="w-full p-1 bg-gray-100 text-gray-600 text-sm rounded border-gray-300 mb-1">
                            <textarea id="seed-replies-textarea" rows="10" required class="w-full p-2 border border-gray-300 rounded-md" placeholder="Câu trả lời 1&#10;Câu trả lời 2&#10;[QUOTE]Bài hay quá[/QUOTE] Mình cũng thấy vậy."></textarea>
                        </div>

                        <div>
                            <button type="submit" class="px-5 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-all">
                                Bắt đầu Đăng Hàng loạt
                            </button>
                            <span id="seed-replies-status" class="text-blue-600 ml-4"></span>
                        </div>
                    </form>
                </div>
                
                <!-- Công cụ 2: Bơm điểm Game -->
                <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <h3 class="text-lg font-semibold">Công cụ 2: Bơm Điểm Bảng Xếp Hạng (Game)</h3>
                    <p class="text-sm text-gray-500 mb-3">Tự động thêm người chơi "ảo" vào bảng xếp hạng game trắc nghiệm.</p>
                    
                    <form id="seed-quiz-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="seed-quiz-count" class="block font-medium">Số lượng "người chơi"</label>
                                <input type="number" id="seed-quiz-count" value="20" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                             <div>
                                <label for="seed-quiz-min-score" class="block font-medium">Điểm thấp nhất (chia hết cho 10)</label>
                                <input type="number" id="seed-quiz-min-score" value="30" step="10" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                             <div>
                                <label for="seed-quiz-max-score" class="block font-medium">Điểm cao nhất (chia hết cho 10)</label>
                                <input type="number" id="seed-quiz-max-score" value="150" step="10" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="seed-quiz-start-date" class="block font-medium text-sm">Chơi từ ngày (Tùy chọn)</label>
                                <input type="date" id="seed-quiz-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="seed-quiz-end-date" class="block font-medium text-sm">Chơi đến ngày (Tùy chọn)</label>
                                <input type="date" id="seed-quiz-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="px-5 py-2 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-all">
                                Bắt đầu Bơm Điểm
                            </button>
                            <span id="seed-quiz-status" class="text-blue-600 ml-4"></span>
                        </div>
                    </form>
                    
                    <!-- Nút Reset Bảng Xếp Hạng -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-semibold text-red-700">Hành động Nguy hiểm</h4>
                        <p class="text-sm text-gray-500 mb-3">Xóa vĩnh viễn TOÀN BỘ dữ liệu trong Bảng xếp hạng.</p>
                        <button id="reset-leaderboard-btn" class="px-5 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition-all flex items-center">
                            <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                            Xóa Sạch Bảng Xếp Hạng
                        </button>
                    </div>
                </div>
                
                <!-- Công cụ 3: Bơm "Thích" (Like) -->
                <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <h3 class="text-lg font-semibold">Công cụ 3: Bơm "Thích" (Like) Hàng loạt</h3>
                    <p class="text-sm text-gray-500 mb-3">Tự động thêm "Thích" vào các bình luận của một chủ đề để tăng tương tác.</p>
                    
                    <form id="seed-likes-form" class="space-y-4">
                        <div>
                            <label for="seed-likes-topic-select" class="block font-medium">1. Chọn Chủ đề có sẵn</label>
                            <select id="seed-likes-topic-select" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <!-- JS sẽ tải các chủ đề vào đây -->
                            </select>
                        </div>
                        
                        <div>
                            <label for="seed-likes-count" class="block font-medium">2. Tổng số lượt "Thích" muốn thêm</label>
                            <input type="number" id="seed-likes-count" value="100" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>

                        <div>
                            <button type="submit" class="px-5 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition-all">
                                Bắt đầu Bơm "Thích"
                            </button>
                            <span id="seed-likes-status" class="text-blue-600 ml-4"></span>
                        </div>
                    </form>
                </div>

            </div>

        </div> <!-- Kết thúc #admin-dashboard -->

    </main>
    
    <!-- 
      ==================================================================
      PHẦN JAVASCRIPT
      ==================================================================
    -->
    <script>
        // (Khởi tạo Biến và DOM)
        let db;
        let auth;
        let currentUser = null; 
        let quill; // Sẽ được khởi tạo sau

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error("Lỗi khởi tạo Firebase: ", e);
            document.getElementById('admin-loader').innerHTML = "Lỗi tải config. Hãy kiểm tra console (F12).";
        }
        
        // (DOM Elements)
        const loader = document.getElementById('admin-loader');
        const denied = document.getElementById('admin-denied');
        const dashboard = document.getElementById('admin-dashboard');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        // (DOM Tables)
        const postsTable = document.getElementById('posts-table-body');
        const topicsTable = document.getElementById('topics-table-body');
        const usersTable = document.getElementById('users-table-body');
        // (ĐÃ XÓA) gamesTable
        const quizzesTable = document.getElementById('quizzes-table-body'); 
        // (DOM Forms)
        const togglePostFormBtn = document.getElementById('toggle-post-form');
        const createPostForm = document.getElementById('create-post-form');
        // (ĐÃ XÓA) toggleGameFormBtn, createGameForm
        const toggleQuizFormBtn = document.getElementById('toggle-quiz-form'); 
        const createQuizForm = document.getElementById('create-quiz-form'); 
        
        // (DOM Elements cho Tab Công cụ)
        // (ĐÃ XÓA) seedTopicsBtn và seedTopicsStatus
        const seedAdvancedRepliesForm = document.getElementById('seed-advanced-replies-form');
        const seedRepliesTopicSelect = document.getElementById('seed-replies-topic-select');
        const seedRepliesTextarea = document.getElementById('seed-replies-textarea');
        const seedRepliesStatus = document.getElementById('seed-replies-status');
        const seedQuizForm = document.getElementById('seed-quiz-form');
        const seedQuizStatus = document.getElementById('seed-quiz-status');
        const seedLikesForm = document.getElementById('seed-likes-form');
        const seedLikesTopicSelect = document.getElementById('seed-likes-topic-select');
        const seedLikesStatus = document.getElementById('seed-likes-status');
        const resetLeaderboardBtn = document.getElementById('reset-leaderboard-btn');


        // (Hàm formatFirebaseDate giữ nguyên...)
        function formatFirebaseDate(timestamp) {
            if (!timestamp) return 'Không rõ';
            return timestamp.toDate().toLocaleDateString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
        }
        
        // --- 3. HÀM TẢI DỮ LIỆU ---
        
        async function loadAllPosts() { 
            try {
                const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();
                let html = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    html += `
                        <tr class="border-b">
                            <td class="p-4">${post.title}</td>
                            <td class="p-4">${post.category}</td>
                            <td class="p-4">${formatFirebaseDate(post.createdAt)}</td>
                            <td class="p-4">
                                <a href="viewbaiviet.html?id=${doc.id}" target="_blank" class="text-teal-600 hover:underline">Xem</a> |
                                <button onclick="deleteDoc('posts', '${doc.id}', loadAllPosts)" class="text-red-600 hover:underline">Xóa</button>
                            </td>
                        </tr>
                    `;
                });
                postsTable.innerHTML = html;
            } catch (error) {
                console.error("Lỗi tải bài viết:", error);
                postsTable.innerHTML = `<tr><td colspan="4" class="p-4 text-red-500">Không thể tải bài viết.</td></tr>`;
            }
        }
        
        // (ĐÃ XÓA) loadAllGames()
        
        async function loadAllQuizzes() { 
            try {
                const snapshot = await db.collection('quizzes').orderBy('createdAt', 'desc').get();
                let html = '';
                snapshot.forEach(doc => {
                    const quiz = doc.data();
                    const correctAnswerText = (quiz.options && quiz.options[quiz.correctAnswer - 1]) 
                                              ? quiz.options[quiz.correctAnswer - 1] 
                                              : 'Lỗi dữ liệu'; 
                    
                    html += `
                        <tr class="border-b">
                            <td class="p-4">${quiz.question}</td>
                            <td class="p-4 font-medium text-green-600">${correctAnswerText}</td>
                            <td class="p-4">
                                <button onclick="deleteDoc('quizzes', '${doc.id}', loadAllQuizzes)" class="text-red-600 hover:underline">Xóa</button>
                            </td>
                        </tr>
                    `;
                });
                quizzesTable.innerHTML = html;
            } catch (error) {
                console.error("Lỗi tải câu đố:", error);
                quizzesTable.innerHTML = `<tr><td colspan="3" class="p-4 text-red-500">Không thể tải câu đố.</td></tr>`;
            }
        }
        
        async function loadAllTopics() { 
             try {
                const snapshot = await db.collection('topics').orderBy('createdAt', 'desc').get();
                let html = '';
                snapshot.forEach(doc => {
                    const topic = doc.data();
                    html += `
                        <tr class="border-b">
                            <td class="p-4">${topic.title}</td>
                            <td class="p-4">${topic.authorName}</td>
                            <td class="p-4">${formatFirebaseDate(topic.createdAt)}</td>
                            <td class="p-4">
                                <a href="viewdiendan.html?id=${doc.id}" target="_blank" class="text-teal-600 hover:underline">Xem</a> |
                                <button onclick="deleteTopic('${doc.id}')" class="text-red-600 hover:underline">Xóa</button>
                            </td>
                        </tr>
                    `;
                });
                topicsTable.innerHTML = html; 
            } catch (error) {
                console.error("Lỗi tải chủ đề:", error);
                topicsTable.innerHTML = `<tr><td colspan="4" class="p-4 text-red-500">Không thể tải chủ đề.</td></tr>`;
            }
        }
        
        async function loadAllUsers() { 
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <tr class="border-b">
                            <td class="p-4">${user.displayName}</td>
                            <td class="p-4">${user.email}</td>
                            <td class="p-4">${user.role === 'admin' ? '<span class="font-bold text-red-500">Admin</span>' : 'User'}</td>
                            <td class="p-4">${formatFirebaseDate(user.createdAt)}</td>
                        </tr>
                    `;
                });
                usersTable.innerHTML = html; 
            } catch (error) {
                console.error("Lỗi tải người dùng:", error);
                usersTable.innerHTML = `<tr><td colspan="4" class="p-4 text-red-500">Không thể tải người dùng.</td></tr>`;
            }
        }
        
        async function loadAllTopicsForSeeding() {
            try {
                seedRepliesTopicSelect.innerHTML = '<option value="">Đang tải chủ đề...</option>';
                seedLikesTopicSelect.innerHTML = '<option value="">Đang tải chủ đề...</option>'; 
                
                const snapshot = await db.collection('topics').orderBy('createdAt', 'desc').get();
                let selectHtml = '<option value="">-- Chọn một chủ đề --</option>';
                
                if (snapshot.empty) {
                     selectHtml = '<option value="">Chưa có chủ đề nào.</option>';
                } else {
                    snapshot.forEach(doc => {
                        const topic = doc.data();
                        const shortTitle = topic.title.length > 70 ? topic.title.substring(0, 70) + '...' : topic.title;
                        selectHtml += `<option value="${doc.id}">${shortTitle}</option>`;
                    });
                }
                seedRepliesTopicSelect.innerHTML = selectHtml;
                seedLikesTopicSelect.innerHTML = selectHtml; 
                
            } catch (error) {
                console.error("Lỗi tải chủ đề cho seeding:", error);
                seedRepliesTopicSelect.innerHTML = '<option value="">Lỗi tải danh sách.</option>';
                seedLikesTopicSelect.innerHTML = '<option value="">Lỗi tải danh sách.</option>';
            }
        }


        // --- 4. HÀM HÀNH ĐỘNG (XÓA/TẠO) ---
        
        async function uploadImageToImgBB(file) {
            if (typeof IMGBB_API_KEY === 'undefined' || IMGBB_API_KEY === "YOUR_IMGBB_API_KEY_HERE") {
                console.error("IMGBB_API_KEY is not set in key.js");
                alert("Lỗi: Chưa cấu hình API key cho ImgBB (trong file key.js).");
                return null;
            }
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) { throw new Error(`Upload failed with status: ${response.status}`); }
                const result = await response.json();
                if (result.data && result.data.url) {
                    return result.data.url;
                } else { throw new Error("Invalid response from ImgBB"); }
            } catch (error) {
                console.error("Lỗi upload ImgBB:", error);
                alert("Đã xảy ra lỗi khi tải ảnh lên. Vui lòng thử lại.");
                return null;
            }
        }
        
        async function quillImageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;
                quill.enable(false); 
                const statusMsg = document.getElementById('upload-status');
                statusMsg.innerText = "Đang tải ảnh nội dung...";
                const imageUrl = await uploadImageToImgBB(file);
                quill.enable(true); 
                statusMsg.innerText = ""; 
                if (imageUrl) {
                    const range = quill.getSelection(true); 
                    quill.insertEmbed(range.index, 'image', imageUrl);
                    quill.setSelection(range.index + 1); 
                }
            };
        }

        async function deleteDoc(collectionName, docId, refreshFunction) {
            if (confirm(`Bạn có chắc muốn xóa vĩnh viễn mục này không?`)) {
                try {
                    await db.collection(collectionName).doc(docId).delete();
                    alert("Xóa thành công!");
                    if (refreshFunction) refreshFunction(); // Tải lại bảng nếu có
                } catch (error) {
                    console.error("Lỗi khi xóa:", error);
                    alert("Đã xảy ra lỗi khi xóa.");
                }
            }
        }
        
        async function deleteQueryBatch(db, query) {
            const snapshot = await query.get();
            if (snapshot.size === 0) {
                return; // Không còn gì để xóa
            }
            
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            
            if (snapshot.size > 0) {
                await deleteQueryBatch(db, query);
            }
        }

        async function deleteTopic(topicId) {
            if (confirm(`Bạn có chắc muốn xóa vĩnh viễn chủ đề này VÀ TẤT CẢ CÁC TRẢ LỜI bên trong không?\n\nHành động này không thể hoàn tác.`)) {
                
                const originalHtml = topicsTable.innerHTML;
                topicsTable.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-blue-600">Đang xóa chủ đề và tất cả trả lời...</td></tr>`;

                try {
                    const repliesQuery = db.collection('topics').doc(topicId).collection('replies').limit(500);
                    await deleteQueryBatch(db, repliesQuery);
                    
                    await db.collection('topics').doc(topicId).delete();

                    alert("Xóa chủ đề và các trả lời thành công!");
                    loadAllTopics(); 
                    loadAllTopicsForSeeding(); 

                } catch (error) {
                    console.error("Lỗi khi xóa chủ đề:", error);
                    alert("Đã xảy ra lỗi khi xóa. Vui lòng kiểm tra Console (F12).");
                    topicsTable.innerHTML = originalHtml; 
                }
            }
        }
        
        // (SỬA LỖI) Đã dán code vào các hàm submit
        if (createPostForm) {
            createPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusMsg = document.getElementById('post-form-message');
                const uploadStatus = document.getElementById('upload-status');
                statusMsg.innerText = "";
                uploadStatus.innerText = "";
                
                const title = document.getElementById('post-title').value;
                const category = document.getElementById('post-category').value;
                const description = document.getElementById('post-description').value;
                const content = quill.root.innerHTML; 
                const coverImageFile = document.getElementById('post-cover-image').files[0];

                let coverImageUrl = null; 

                if (coverImageFile) {
                    uploadStatus.innerText = "Đang tải ảnh bìa...";
                    coverImageUrl = await uploadImageToImgBB(coverImageFile);
                    if (!coverImageUrl) {
                        uploadStatus.innerText = "Lỗi tải ảnh bìa. Đã hủy lưu.";
                        return; 
                    }
                    uploadStatus.innerText = "Tải ảnh bìa thành công.";
                }

                try {
                    statusMsg.innerText = "Đang lưu bài viết...";
                    await db.collection('posts').add({
                        title: title,
                        category: category,
                        description: description,
                        content: content,
                        coverImageUrl: coverImageUrl, 
                        authorName: currentUser.displayName, 
                        authorId: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    statusMsg.innerText = "Tạo bài viết thành công!";
                    uploadStatus.innerText = "";
                    createPostForm.reset(); 
                    quill.root.innerHTML = ""; 
                    loadAllPosts(); 
                    
                    setTimeout(() => {
                        statusMsg.innerText = "";
                    }, 3000);

                } catch (error) {
                    console.error("Lỗi tạo bài viết:", error);
                    statusMsg.innerText = "Lỗi! Vui lòng thử lại.";
                }
            });
        }
        
        // (ĐÃ XÓA) if (createGameForm)
        
        if (createQuizForm) {
            createQuizForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                
                const statusMsg = document.getElementById('quiz-form-message');
                statusMsg.innerText = "Đang lưu...";

                const question = document.getElementById('quiz-question').value;
                const opt1 = document.getElementById('quiz-option-1').value;
                const opt2 = document.getElementById('quiz-option-2').value;
                const opt3 = document.getElementById('quiz-option-3').value;
                const opt4 = document.getElementById('quiz-option-4').value;
                const correctAnswer = parseInt(document.getElementById('quiz-correct-answer').value, 10);

                if (!question || !opt1 || !opt2 || !opt3 || !opt4) {
                    statusMsg.innerText = "Vui lòng điền đầy đủ câu hỏi và 4 phương án.";
                    return;
                }

                try {
                    await db.collection('quizzes').add({
                        question: question,
                        options: [opt1, opt2, opt3, opt4],
                        correctAnswer: correctAnswer, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    statusMsg.innerText = "Tạo câu đố thành công!";
                    createQuizForm.reset();
                    loadAllQuizzes(); 
                    
                    setTimeout(() => { statusMsg.innerText = ""; }, 3000);

                } catch (error) {
                    console.error("Lỗi tạo câu đố:", error);
                    statusMsg.innerText = "Lỗi! Vui lòng thử lại.";
                }
            });
        }


        // --- 5. KỊCH BẢN TẠO DỮ LIỆU MẪU ---
        
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        // (Ngân hàng tên với >1000 kết hợp)
        const SEED_NAMES = {
            last: [
                'Nguyễn', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Huỳnh', 'Võ', 'Phan', 'Trương', 'Bùi',
                'Đặng', 'Đỗ', 'Ngô', 'Hồ', 'Dương', 'Đinh', 'Đoàn', 'Vũ', 'Cao', 'Lý', 'Hà', 
                'Phùng', 'Mai', 'Lâm', 'Tạ', 'Đào', 'Tô', 'Trịnh', 'Lưu', 'Châu'
            ],
            first: [
                'Anh', 'Bảo', 'Châu', 'Duy', 'Đạt', 'Giang', 'Hà', 'Huy', 'Hùng', 'Khánh', 
                'Khoa', 'Kiên', 'Lam', 'Linh', 'Long', 'Minh', 'Nam', 'Nga', 'Ngọc', 'Phát', 
                'Phương', 'Quân', 'Quang', 'Sơn', 'Tâm', 'Thắng', 'Thành', 'Thảo', 'Thiên', 'Trang',
                'Trung', 'Tuấn', 'Tú', 'Vân', 'Việt', 'Vinh', 'An', 'Bình', 'Cường', 'Dũng'
            ]
        };
        function getRandomFakeName() {
            const last = SEED_NAMES.last[Math.floor(Math.random() * SEED_NAMES.last.length)];
            const first = SEED_NAMES.first[Math.floor(Math.random() * SEED_NAMES.first.length)];
            return `${last} ${first}`;
        }
        
        // (Hàm chuyển đổi quy ước [QUOTE])
        function parseReplyContent(contentText, authorName = "") {
            let contentHTML = '';
            const quoteMatch = contentText.match(/\[QUOTE\](.*?)\[\/QUOTE\](.*)/s);
            
            if (quoteMatch) {
                const quotedText = quoteMatch[1].trim();
                const replyText = quoteMatch[2].trim();
                // (SỬA LỖI) Chỉ hiển thị text trích dẫn, không gán tên
                contentHTML = `<blockquote><p><em>${quotedText}</em></p></blockquote><p>${replyText}</p>`;
            } else {
                contentHTML = `<p>${contentText}</p>`;
            }
            return contentHTML;
        }

        // (Hàm tạo ngày giờ ngẫu nhiên)
        function getRandomTimestamp(startDateString, endDateString) {
            const now = new Date(); 
            let start, end;

            if (!startDateString) {
                start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).getTime();
            } else {
                start = new Date(startDateString).getTime();
            }

            if (!endDateString) {
                end = now.getTime();
            } else {
                end = new Date(endDateString).getTime();
            }
            
            if (isNaN(start)) start = now.getTime() - 7 * 24 * 60 * 60 * 1000;
            if (isNaN(end)) end = now.getTime();
            
            if (end < start) {
                [start, end] = [end, start]; // Swap
            }
            
            const endDateObj = new Date(end);
            endDateObj.setHours(23, 59, 59);
            end = endDateObj.getTime();

            const randomTime = start + Math.random() * (end - start);
            return firebase.firestore.Timestamp.fromDate(new Date(randomTime));
        }

        // (ĐÃ XÓA) Kịch bản 1: handleTopicSeedSubmit()

        // (Kịch bản 2: Bơm Trả lời Hàng loạt (Nâng cao))
        async function handleAdvancedReplySeedSubmit(e) {
            e.preventDefault();
            
            const topicId = seedRepliesTopicSelect.value;
            const repliesText = seedRepliesTextarea.value.trim();
            const startDate = document.getElementById('seed-replies-start-date').value;
            const endDate = document.getElementById('seed-replies-end-date').value;
            
            if (!topicId) {
                alert("Vui lòng chọn một chủ đề.");
                return;
            }
            if (!repliesText) {
                alert("Vui lòng dán danh sách trả lời vào ô nội dung.");
                return;
            }
            
            const repliesArray = repliesText.split('\n').filter(line => line.trim().length > 0);
            const replyCount = repliesArray.length;

            if (replyCount === 0) {
                alert("Không tìm thấy câu trả lời hợp lệ.");
                return;
            }
            
            if (!confirm(`Bạn có chắc muốn thêm ${replyCount} trả lời vào chủ đề đã chọn không?`)) {
                return;
            }
            
            const submitButton = seedAdvancedRepliesForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            seedRepliesStatus.innerText = "Đang kiểm tra chủ đề...";

            try {
                const topicRef = db.collection("topics").doc(topicId);
                const topicDoc = await topicRef.get();
                if (!topicDoc.exists) throw new Error("Không tìm thấy chủ đề với ID này.");
                
                const topicCreatedAt = topicDoc.data().createdAt.toDate();
                let effectiveStartDate = startDate ? new Date(startDate) : topicCreatedAt;
                if (effectiveStartDate < topicCreatedAt) effectiveStartDate = topicCreatedAt;
                
                let lastReplyTime = topicDoc.data().lastReplyAt.toDate();
                if (lastReplyTime < effectiveStartDate) lastReplyTime = effectiveStartDate;

                for (let i = 0; i < replyCount; i++) {
                    const lineText = repliesArray[i];
                    seedRepliesStatus.innerText = `Đang tạo trả lời ${i + 1}/${replyCount}...`;
                    
                    const randomName = getRandomFakeName();
                    const contentHTML = parseReplyContent(lineText); 
                    
                    const replyTime = getRandomTimestamp(lastReplyTime.toISOString(), endDate);

                    const newReplyData = {
                        content: contentHTML,
                        authorName: randomName,
                        authorId: `bot-id-${Math.random()}`,
                        createdAt: replyTime 
                    };
                    
                    await topicRef.collection("replies").add(newReplyData);
                    
                    await topicRef.update({
                        replyCount: firebase.firestore.FieldValue.increment(1),
                        lastReplyAt: replyTime 
                    });
                    
                    lastReplyTime = replyTime.toDate(); 
                    
                    const randomDelay = 500 + Math.random() * 500;
                    await delay(randomDelay);
                }
                
                seedRepliesStatus.innerText = `Hoàn thành! Đã thêm ${replyCount} trả lời.`;
                seedRepliesTextarea.value = ''; 
                loadAllTopics(); 

            } catch (error) {
                console.error("Lỗi khi bơm seeding:", error);
                seedRepliesStatus.innerText = `Lỗi: ${error.message}`;
            } finally {
                submitButton.disabled = false;
            }
        }
        
        // (Kịch bản 3: Bơm Điểm Game)
        async function handleQuizSeedSubmit(e) {
            e.preventDefault();
            
            const count = parseInt(document.getElementById('seed-quiz-count').value, 10);
            const minScoreInput = parseInt(document.getElementById('seed-quiz-min-score').value, 10);
            const maxScoreInput = parseInt(document.getElementById('seed-quiz-max-score').value, 10);
            const startDate = document.getElementById('seed-quiz-start-date').value;
            const endDate = document.getElementById('seed-quiz-end-date').value;

            if (!count || minScoreInput === null || maxScoreInput === null || count <= 0 || maxScoreInput < minScoreInput) {
                alert("Dữ liệu không hợp lệ. Vui lòng kiểm tra lại số lượng và điểm.");
                return;
            }
            
            const minScore = Math.round(minScoreInput / 10) * 10;
            const maxScore = Math.round(maxScoreInput / 10) * 10;
            
            if (!confirm(`Bạn có chắc muốn tạo ${count} điểm số ảo (từ ${minScore} đến ${maxScore} điểm) không?`)) {
                return;
            }
            
            const submitButton = seedQuizForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            seedQuizStatus.innerText = "Đang tạo điểm số ảo...";

            try {
                const batch = db.batch();
                
                for (let i = 0; i < count; i++) {
                    const randomName = getRandomFakeName();
                    const randomScoreRaw = Math.floor(Math.random() * (maxScore - minScore + 1)) + minScore;
                    const randomScore = Math.round(randomScoreRaw / 10) * 10;
                    const randomUserId = `bot-score-${Math.random().toString(36).substring(2, 11)}`;
                    const fakeTimestamp = getRandomTimestamp(startDate, endDate);
                    
                    const scoreRef = db.collection('quizLeaderboard').doc(randomUserId);
                    batch.set(scoreRef, {
                        score: randomScore,
                        userName: randomName,
                        userId: randomUserId,
                        lastPlayed: fakeTimestamp
                    });
                }
                
                await batch.commit();
                seedQuizStatus.innerText = `Hoàn thành! Đã thêm ${count} điểm số.`;

            } catch (error) {
                console.error("Lỗi khi bơm điểm game:", error);
                seedQuizStatus.innerText = `Lỗi: ${error.message}`;
            } finally {
                submitButton.disabled = false;
            }
        }
        
        // (Kịch bản 4: Bơm "Thích" (Like))
        async function handleLikeSeedSubmit(e) {
            e.preventDefault();
            
            const topicId = seedLikesTopicSelect.value;
            const likeCount = parseInt(document.getElementById('seed-likes-count').value, 10);

            if (!topicId) {
                alert("Vui lòng chọn một chủ đề.");
                return;
            }
            if (!likeCount || likeCount <= 0) {
                alert("Số lượng 'Thích' phải lớn hơn 0.");
                return;
            }
            
            if (!confirm(`Bạn có chắc muốn thêm ${likeCount} lượt "Thích" ngẫu nhiên vào chủ đề này không?`)) {
                return;
            }
            
            const submitButton = seedLikesForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            seedLikesStatus.innerText = "Đang tải bình luận...";

            try {
                const repliesSnapshot = await db.collection('topics').doc(topicId).collection('replies').get();
                if (repliesSnapshot.empty) {
                    throw new Error("Chủ đề này không có bình luận nào để Thích.");
                }
                
                const replyRefs = repliesSnapshot.docs.map(doc => doc.ref);
                
                seedLikesStatus.innerText = `Đang bơm ${likeCount} lượt "Thích"...`;
                
                const batch = db.batch();
                for (let i = 0; i < likeCount; i++) {
                    const randomReplyRef = replyRefs[Math.floor(Math.random() * replyRefs.length)];
                    const randomUserId = `bot-like-${Math.random().toString(36).substring(2, 9)}`;
                    
                    batch.update(randomReplyRef, {
                        likedBy: firebase.firestore.FieldValue.arrayUnion(randomUserId),
                        likeCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                await batch.commit();
                
                seedLikesStatus.innerText = `Hoàn thành! Đã thêm ${likeCount} lượt "Thích".`;

            } catch (error) {
                console.error("Lỗi khi bơm 'Thích':", error);
                seedLikesStatus.innerText = `Lỗi: ${error.message}`;
            } finally {
                submitButton.disabled = false;
            }
        }
        
        // (Kịch bản 5: Reset Bảng Xếp Hạng)
        async function handleResetLeaderboard() {
            if (!confirm("BẠN CÓ CHẮC KHÔNG?\n\nHành động này sẽ XÓA SẠCH toàn bộ Bảng xếp hạng game. Không thể hoàn tác!")) {
                return;
            }
            
            const submitButton = seedQuizForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            resetLeaderboardBtn.disabled = true;
            seedQuizStatus.innerText = "Đang xóa toàn bộ Bảng xếp hạng...";

            try {
                const query = db.collection('quizLeaderboard').limit(500);
                await deleteQueryBatch(db, query);
                
                seedQuizStatus.innerText = "Xóa Bảng xếp hạng thành công!";
                alert("Xóa Bảng xếp hạng thành công!");

            } catch (error) {
                console.error("Lỗi khi xóa BXH:", error);
                seedQuizStatus.innerText = `Lỗi: ${error.message}`;
            } finally {
                submitButton.disabled = false;
                resetLeaderboardBtn.disabled = false;
            }
        }
        
        // (ĐÃ XÓA) Logic AI

        // --- 7. LOGIC ĐIỀU HƯỚNG TAB ---
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabPanels.forEach(panel => panel.classList.add('hidden'));
                const panelId = button.getAttribute('data-panel');
                document.getElementById(panelId).classList.remove('hidden');
                
                // (SỬA LỖI QUILL)
                if (panelId === 'posts-panel' && !quill) {
                    try {
                        quill = new Quill('#quill-editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: {
                                    container: [
                                        [{ 'header': [1, 2, 3, false] }],
                                        ['bold', 'italic', 'underline', 'strike'],
                                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                        ['link', 'image', 'blockquote', 'code-block'],
                                        [{ 'color': [] }, { 'background': [] }],
                                        ['clean']
                                    ],
                                    handlers: { 'image': quillImageHandler }
                                }
                            },
                            placeholder: 'Nhập nội dung bài viết ở đây...'
                        });
                    } catch (e) {
                        console.error("Không thể khởi tạo Quill:", e);
                    }
                }
            });
        });

        togglePostFormBtn.onclick = () => {
            createPostForm.classList.toggle('hidden');
            togglePostFormBtn.innerText = createPostForm.classList.contains('hidden') ? "+ Tạo bài viết mới" : "Đóng Form";
        };
        // (ĐÃ XÓA) toggleGameFormBtn.onclick
        toggleQuizFormBtn.onclick = () => {
            createQuizForm.classList.toggle('hidden');
            toggleQuizFormBtn.innerText = createQuizForm.classList.contains('hidden') ? "+ Tạo câu đố mới" : "Đóng Form";
        };

        // --- 8. HÀM KIỂM TRA QUYỀN (Auth) ---
        async function checkAdminAccess() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user; 
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists && userDoc.data().role === 'admin') {
                            loader.style.display = 'none';
                            dashboard.classList.remove('hidden');
                            
                            // (SỬA LỖI QUILL)
                            if (!quill) {
                                try {
                                    quill = new Quill('#quill-editor', {
                                        // (Code khởi tạo Quill)
                                    });
                                } catch(e) { console.error(e); }
                            }
                            
                            // Tải tất cả dữ liệu
                            loadAllPosts();
                            // (ĐÃ XÓA) loadAllGames(); 
                            loadAllQuizzes(); 
                            loadAllTopics();
                            loadAllUsers();
                            loadAllTopicsForSeeding(); 

                            // Gắn sự kiện
                            // (ĐÃ XÓA) seedTopicsBtn.onclick
                            seedAdvancedRepliesForm.onsubmit = handleAdvancedReplySeedSubmit;
                            seedQuizForm.onsubmit = handleQuizSeedSubmit; 
                            seedLikesForm.onsubmit = handleLikeSeedSubmit; 
                            resetLeaderboardBtn.onclick = handleResetLeaderboard;
                            
                        } else {
                            loader.style.display = 'none';
                            denied.classList.remove('hidden');
                        }
                    } catch (error) { 
                        console.error("Lỗi kiểm tra quyền:", error);
                        loader.style.display = 'none';
                        denied.classList.remove('hidden');
                    }
                } else {
                    loader.style.display = 'none';
                    denied.classList.remove('hidden');
                }
            });
        }
        
        // --- 9. KÍCH HOẠT KHI TẢI TRANG ---
        window.addEventListener('DOMContentLoaded', () => {
            if (db && auth) {
                checkAdminAccess();
            }
            feather.replace(); // Kích hoạt icons (cho nút Xóa)
        });

    </script>

</body>
</html>
